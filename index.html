import React, { useState, useEffect } from 'react';
import { 
  Check, 
  Camera, 
  Gift, 
  Twitter, 
  MessageCircle, 
  ChevronDown, 
  ChevronUp, 
  Smile,
  AlertTriangle,
  HelpCircle,
  Ban,
  ShoppingBag,
  Ticket,
  Copy,
  Heart,
  Info,
  Volume2,
  X,
  ExternalLink
} from 'lucide-react';

const BanggeulriGuide = () => {
  const [checkedItems, setCheckedItems] = useState({});
  const [openFaqId, setOpenFaqId] = useState(null);
  const [isCopied, setIsCopied] = useState(false);
  const [showToast, setShowToast] = useState(false);
  const [toastMessage, setToastMessage] = useState(""); // 토스트 메시지 내용 동적 관리
  const [showDefectModal, setShowDefectModal] = useState(false);

  // FAQ 토글
  const toggleFaq = (id) => {
    setOpenFaqId(prev => (prev === id ? null : id));
  };

  // 🔊 효과음 재생 함수 (모든 체크리스트에 적용)
  const playSuccessSound = () => {
    try {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (!AudioContext) return;
      
      const ctx = new AudioContext();
      const oscillator = ctx.createOscillator();
      const gainNode = ctx.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(ctx.destination);

      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(523.25, ctx.currentTime); 
      oscillator.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); 

      gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);

      oscillator.start();
      oscillator.stop(ctx.currentTime + 0.4);
    } catch (e) {
      console.error("Audio play failed", e);
    }
  };

  // 해시태그 복사 기능
  const handleCopyHashtags = () => {
    const tags = "#뱅그리랑_와글와글 #뱅그리가왔그리";
    const textArea = document.createElement("textarea");
    textArea.value = tags;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      setIsCopied(true);
      setTimeout(() => setIsCopied(false), 2000);
    } catch (err) {
      console.error('복사 실패', err);
    }
    document.body.removeChild(textArea);
  };

  // 체크리스트 데이터
  const checklistData = [
    { id: 1, text: "입양증 (인형 1개당 3장)" },
    { id: 2, text: "스티커 (인형 1개당 5장)" },
    { id: 3, text: "[선입금] 띠부띠부씰 (인형 1개당 1장)" },
    { id: 4, text: "[수요조사] 칼선 스티커 (6장)", type: 'survey', highlight: true }, 
    { id: 5, text: "오리지널 티켓 (주문건당 1개)" },
    { id: 6, text: "칼선 부적 (주문건당 4장)" },
    { id: 7, text: "[세트] 칼선X 부적 (세트만 1장)" },
    { id: 8, text: "[세트] 동그리 자켓 (★추후 별도 배송★)", highlight: true },
    { id: 9, text: "[선물] 파우치 (1~3개:1개 / 4~6개:2개)", type: 'pouch' },
  ];

  // 체크리스트 토글 핸들러
  const toggleCheck = (item) => {
    const willCheck = !checkedItems[item.id];
    setCheckedItems(prev => ({ ...prev, [item.id]: willCheck }));

    // 1. 소리는 무조건 재생
    if (willCheck) {
      playSuccessSound();

      // 2. 특정 아이템 메시지 처리
      if (item.type === 'survey') {
        setToastMessage("수요조사 참여 감사합니다! 🧡");
        setShowToast(true);
        setTimeout(() => setShowToast(false), 3000);
      } else if (item.type === 'pouch') {
        setToastMessage("뱅그리를 입양해주셔서 감사합니다! 🙇‍♀️");
        setShowToast(true);
        setTimeout(() => setShowToast(false), 3000);
      }
    }
  };

  // FAQ 데이터
  const faqData = [
    {
      id: 1,
      icon: <AlertTriangle size={18} className="text-red-500" />,
      q: "동그리 자켓이 안 왔어요! 누락인가요?",
      a: "아닙니다! 📢 동그리 자켓은 제작 일정상 추후 '준등기'로 별도 배송될 예정입니다. 누락된 것이 아니니 조금만 더 기다려주세요!"
    },
    {
      id: 2,
      icon: <Ban size={18} className="text-red-500" />,
      q: "세탁해도 되나요?",
      a: "권장하지 않습니다! ❌ 인형의 변형이 올 수 있으므로 전체 세탁은 피해주세요. 오염된 부분만 젖은 수건으로 살살 닦아주시는 것을 추천합니다."
    },
    {
      id: 3,
      icon: <ShoppingBag size={18} className="text-purple-500" />,
      q: "재고 판매(재판) 계획이 있나요?",
      a: "추가 제작(재판) 예정은 없습니다. 🙅‍♀️ 배송 및 불량 교환이 모두 끝난 후, 극소량의 남은 재고에 대해서만 판매를 진행할 예정입니다."
    }
  ];

  return (
    <div className="min-h-screen bg-[#FFF8F0] text-gray-800 font-sans selection:bg-orange-200 pb-20 relative">
      
      {/* 1. 동적 토스트 메시지 (수요조사 & 파우치) */}
      <div className={`fixed bottom-24 left-1/2 transform -translate-x-1/2 z-[90] transition-all duration-500 pointer-events-none w-full max-w-sm text-center ${showToast ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}`}>
        <div className="inline-flex items-center bg-gray-900/95 text-white px-6 py-3 rounded-full shadow-2xl backdrop-blur-md border border-white/20">
          <Heart className="text-pink-500 mr-2 fill-current animate-bounce" size={18} />
          <span className="font-bold text-sm whitespace-nowrap">{toastMessage}</span>
        </div>
      </div>

      {/* 2. 불량 문의 확인 모달 */}
      {showDefectModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl relative transform transition-all scale-100">
            <button 
              onClick={() => setShowDefectModal(false)}
              className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
            >
              <X size={24} />
            </button>

            <div className="text-center mb-6">
              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <Camera className="text-red-500" size={32} />
              </div>
              <h3 className="text-xl font-bold text-gray-900 mb-2">잠시만요! ✋</h3>
              <p className="text-sm text-gray-600 leading-relaxed">
                불량 문의를 위해서는<br/>
                <strong className="text-red-500">끊김 없는 원테이크 개봉 영상</strong>이<br/>
                반드시 있어야 합니다.
              </p>
              <p className="text-xs text-gray-400 mt-2">영상이 없으면 공장 기준상 교환이 불가합니다.</p>
            </div>

            <div className="space-y-3">
              {/* 수정된 부분: a 태그 사용으로 링크 연결 확실하게 보장 */}
              <a 
                href="https://x.com/banggeulri819" 
                target="_blank" 
                rel="noreferrer"
                className="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition-colors flex items-center justify-center text-center no-underline"
                onClick={() => setShowDefectModal(false)}
              >
                <Check size={18} className="mr-2" />
                네, 영상이 있습니다
              </a>
              <button 
                onClick={() => setShowDefectModal(false)}
                className="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold py-3 rounded-xl transition-colors"
              >
                다시 확인해볼게요
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 헤더 */}
      <header className="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-orange-100 shadow-sm">
        <div className="max-w-lg mx-auto px-4 py-3 flex justify-between items-center">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-orange-400 rounded-full flex items-center justify-center text-white shadow-md">
              <Smile size={20} />
            </div>
            <span className="font-bold text-lg text-orange-900 tracking-tight">뱅그리 도착!</span>
          </div>
          <a href="https://x.com/banggeulri819?s=21" target="_blank" rel="noreferrer" className="bg-black text-white p-2 rounded-full hover:bg-gray-800 transition-colors">
            <Twitter size={16} />
          </a>
        </div>
      </header>

      <main className="max-w-lg mx-auto">
        
        {/* 인사말 */}
        <section className="p-6 bg-white mb-2">
          <div className="text-center mb-6">
            <h1 className="text-3xl font-bold text-gray-900 mb-2 leading-tight">
              안녕!<br/>난 <span className="text-orange-500">뱅그리</span>라고 해 🍊
            </h1>
            <p className="text-sm text-gray-500 font-medium">총대 지은 올림</p>
          </div>
          <div className="bg-orange-50 p-5 rounded-xl border border-orange-100 text-sm text-gray-700 leading-relaxed shadow-inner">
            <p className="mb-3">
              안녕하세요, 뱅그리 총대 지은입니다.<br/>
              긴 시간 기다려주셔서 진심으로 감사드립니다.
            </p>
            <p>
              뱅그리가 세상에 나올 수 있었던 건<br/>
              전적으로 여러분 덕분입니다.<br/>
              오늘도 뱅그리와 함께 행복한 하루 되세요! :)
            </p>
          </div>
        </section>

        {/* 불량 기준 및 검수 안내 */}
        <section className="px-6 py-4">
          <div className="bg-white border-2 border-gray-200 rounded-2xl p-5 shadow-sm relative overflow-hidden">
            <h2 className="flex items-center text-gray-800 font-bold text-lg mb-3">
              <Info className="mr-2 text-blue-500" size={22} />
              불량 기준 및 교환 안내
            </h2>
            
            <div className="space-y-4 text-sm text-gray-700">
              <div className="bg-blue-50 p-3 rounded-lg text-xs leading-relaxed text-blue-800 font-medium">
                모든 인형은 <strong>공장 1차 검수</strong> 후, 총대가 직접 <strong>2차 검수</strong>까지 꼼꼼히 마친 뒤 배송되었습니다.
              </div>

              <div className="space-y-2">
                <p className="font-bold text-gray-900 border-b border-gray-100 pb-1">✅ 불량이 아닌 경우 (교환 불가)</p>
                <ul className="list-disc list-inside text-xs text-gray-600 space-y-1 ml-1">
                  <li>대량 생산 특성상 발생하는 <strong>개체 차이 및 비대칭</strong></li>
                  <li>실밥 (직접 정리 가능), 미세한 자수 튐</li>
                  <li>봉제 마감 중 발생한 <strong>살짝 탄 자국(열처리)</strong></li>
                  <li>배송 중 눌림으로 인한 모양 변형 <span className="text-blue-500">(경락과 볼터치로 예뻐져요!)</span></li>
                </ul>
              </div>

              <div className="space-y-2">
                <p className="font-bold text-red-600 border-b border-red-100 pb-1">⛔️ 불량 인정 기준 (교환 대상)</p>
                <ul className="list-disc list-inside text-xs text-gray-800 space-y-1 ml-1 font-medium bg-red-50 p-2 rounded">
                  <li>자수 누락</li>
                  <li>지워지지 않는 심한 오염</li>
                  <li>봉제선 터짐</li>
                </ul>
              </div>

              <p className="text-xs text-gray-500 mt-2">
                * 꼼꼼히 확인했으나 놓친 부분이 있을 수 있습니다.<br/>
                문제가 있다면 <span className="font-bold text-red-500 underline">배송 완료 후 3일 이내</span>에 연락주세요.
              </p>

              {/* [수정됨] 불량 문의 버튼 위치 이동: 설명 바로 아래 */}
              <div className="pt-2">
                <button 
                  onClick={() => setShowDefectModal(true)}
                  className="w-full bg-gray-100 border border-gray-300 text-gray-700 font-bold py-2.5 rounded-xl flex items-center justify-center hover:bg-gray-200 transition-all text-sm"
                >
                  <MessageCircle size={16} className="mr-2" />
                  불량 문의하기 (DM)
                </button>
              </div>
            </div>
          </div>
        </section>

        {/* 개봉 영상 가이드 */}
        <section className="px-6 pb-4">
           <div className="bg-red-50 border border-red-200 rounded-xl p-4 flex items-start">
             <Camera className="text-red-500 mr-3 flex-shrink-0 mt-0.5" size={20} />
             <div className="text-xs text-red-800 leading-relaxed">
               <strong className="block text-sm mb-1 text-red-600">불량 문의 필수 조건</strong>
               문의 시 <strong>운송장이 보이는 무편집 원테이크 영상</strong>이 반드시 필요합니다. 영상이 없으면 공장 기준에 따라 교환/환불이 절대 불가합니다.
             </div>
           </div>
        </section>

        {/* 구성품 안내 */}
        <section className="px-6 py-4 bg-white my-4">
          <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
            <Gift className="mr-2 text-orange-500" size={20} />
            구성품 상세 안내
          </h2>

          <div className="space-y-3">
            <div className="bg-white p-4 rounded-xl border border-orange-200 shadow-sm relative">
              <span className="absolute top-3 right-3 text-[10px] font-bold bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full">인형 1개당 지급</span>
              <h3 className="font-bold text-gray-800 mb-2 flex items-center">🧸 인형 1개 구매 시</h3>
              <ul className="text-sm text-gray-600 space-y-1.5 ml-1">
                <li className="flex items-start"><span className="mr-2 text-orange-400">•</span> 입양증 <strong className="ml-1 text-gray-900">3장</strong></li>
                <li className="flex items-start"><span className="mr-2 text-orange-400">•</span> 스티커 <strong className="ml-1 text-gray-900">5장</strong></li>
                <li className="flex items-start"><span className="mr-2 text-orange-400">•</span> [선입금] 띠부띠부씰 <strong className="ml-1 text-gray-900">1장 (랜덤)</strong></li>
              </ul>
            </div>

            <div className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm relative">
              <span className="absolute top-3 right-3 text-[10px] font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">주문건당 지급</span>
              <h3 className="font-bold text-gray-800 mb-2 flex items-center">📦 주문건당 (N개 구매해도 1set)</h3>
              <ul className="text-sm text-gray-600 space-y-1.5 ml-1">
                <li className="flex items-center"><Ticket size={14} className="mr-2 text-blue-400" /> 오리지널 티켓 <strong className="ml-1 text-gray-900">1개</strong></li>
                <li className="flex items-center"><span className="mr-2 text-blue-400 text-xs">📄</span> 칼선 부적 <strong className="ml-1 text-gray-900">4장</strong></li>
                <li className="flex items-center bg-green-50 p-1.5 rounded mt-1">
                   <span className="mr-2 text-green-500 text-xs font-bold">[수요조사]</span> 칼선 스티커 <strong className="ml-1 text-green-800">6장</strong>
                </li>
                <li className="flex items-start bg-gray-50 p-1.5 rounded text-xs text-gray-500 mt-1">
                  <span className="mr-1 text-purple-500 font-bold">※ 세트 구매자만:</span> 
                  칼선X 부적 1장 추가 + 동그리 자켓(별도배송)
                </li>
              </ul>
            </div>

            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-orange-200 shadow-sm">
              <span className="text-xs font-bold bg-yellow-400 text-white px-2 py-1 rounded mb-2 inline-block shadow-sm">🎁 깜짝 선물 (파우치)</span>
              <div className="text-sm text-gray-800 space-y-1 mt-1">
                <p>• 인형 1~3개 구매: <strong className="text-orange-600">파우치 1개</strong></p>
                <p>• 인형 4~6개 구매: <strong className="text-orange-600">파우치 2개</strong></p>
              </div>
              <p className="text-[10px] text-orange-600/80 bg-white/60 p-2 rounded mt-2 leading-tight">
                * 망사 소재라 인쇄가 잘 벗겨질 수 있습니다. (총대 파우치도 이미...😇) 파우치는 덤으로 드리는 선물이니 조심히 사용해주세요!
              </p>
            </div>
          </div>
        </section>

        {/* 체크리스트 (소리 & 메시지 효과) */}
        <section className="p-6 bg-white my-4 border-t border-gray-100">
          <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
            <div className="flex items-center">
              <Check className="mr-2 text-green-500" size={20} />
              빠른 확인 체크리스트
            </div>
            <div className="flex items-center text-xs font-normal text-gray-400">
              <Volume2 size={12} className="mr-1" />
              소리를 켜보세요!
            </div>
          </h2>
          
          <div className="grid grid-cols-1 gap-2">
            {checklistData.map((item) => (
              <div 
                key={item.id}
                onClick={() => toggleCheck(item)}
                className={`
                  flex items-center p-3 rounded-lg border transition-all cursor-pointer select-none
                  ${checkedItems[item.id] 
                    ? 'bg-green-50 border-green-200 text-gray-400' 
                    : 'bg-white border-gray-200 text-gray-700 hover:border-orange-300'}
                `}
              >
                <div className={`
                  w-5 h-5 rounded-full border mr-3 flex items-center justify-center flex-shrink-0 transition-colors
                  ${checkedItems[item.id] ? 'bg-green-500 border-green-500' : 'bg-white border-gray-300'}
                `}>
                  {checkedItems[item.id] && <Check size={12} className="text-white" />}
                </div>
                <div className="flex-1">
                  <span className={`text-sm ${checkedItems[item.id] ? 'line-through decoration-gray-300' : ''}`}>
                    {item.text}
                  </span>
                  {item.highlight && !checkedItems[item.id] && (
                    <span className="block text-[10px] text-red-500 font-medium mt-0.5">⚠️ 확인 필요</span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </section>

        {/* FAQ (버튼 제거됨 - 위로 이동) */}
        <section className="px-6 py-6 bg-[#fafafa]">
          <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center">
            <HelpCircle className="mr-2 text-blue-500" size={20} />
            자주 묻는 질문 (FAQ)
          </h2>
          <div className="space-y-3 mb-6">
            {faqData.map((faq) => (
              <div key={faq.id} className="border border-gray-200 rounded-xl bg-white overflow-hidden shadow-sm">
                <button 
                  onClick={() => toggleFaq(faq.id)}
                  className="w-full flex justify-between items-start p-4 text-left bg-white hover:bg-gray-50 transition-colors"
                >
                  <div className="flex items-start pr-4">
                    <span className="mt-0.5 mr-2 flex-shrink-0">{faq.icon}</span>
                    <span className="font-bold text-sm text-gray-800 leading-snug">{faq.q}</span>
                  </div>
                  {openFaqId === faq.id ? <ChevronUp size={18} className="text-gray-400 flex-shrink-0" /> : <ChevronDown size={18} className="text-gray-400 flex-shrink-0" />}
                </button>
                {openFaqId === faq.id && (
                  <div className="p-4 pt-0 bg-gray-50 text-sm text-gray-600 border-t border-gray-100 leading-relaxed">
                    <div className="mt-3 font-medium whitespace-pre-wrap">{faq.a}</div>
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>

        {/* 후기 이벤트 */}
        <section className="p-6 pt-2">
          <div className="bg-gray-900 text-white rounded-2xl p-6 text-center relative overflow-hidden shadow-xl">
            <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-purple-500 to-pink-500 opacity-20 rounded-full blur-3xl"></div>
            
            <Heart size={28} className="mx-auto mb-3 text-pink-400 animate-pulse" />
            <h2 className="text-lg font-bold mb-2">📸 뱅그리와 추억 만들기</h2>
            
            <div className="bg-white/10 rounded-xl p-4 mb-5 text-sm leading-relaxed text-gray-200 backdrop-blur-md border border-white/10">
              <p className="mb-2">
                "여러분의 후기 사진을 보면 정말 기쁠 것 같아요!"
              </p>
              <p className="font-light opacity-90">
                카페, 여행지, 집 앞 산책로 어디든 좋아요.<br/>
                앞으로 뱅그리와 여기저기 많이 다니면서<br/>
                행복한 순간들을 사진으로 남겨주세요. 🧡
              </p>
            </div>

            <p className="text-xs text-gray-400 mb-3">
              예쁜 후기를 남겨주시면 추첨을 통해<br/>
              <span className="text-yellow-400 font-bold">띠부띠부씰 9종 세트</span>를 드려요!
            </p>
            
            <div className="mb-5">
              <div className="text-xs font-mono text-blue-200 mb-2 break-all text-center opacity-80">
                #뱅그리랑_와글와글 #뱅그리가왔그리
              </div>
              <button 
                onClick={handleCopyHashtags}
                className={`
                  w-full flex items-center justify-center py-2 rounded-lg text-sm font-bold transition-all duration-200 shadow-md
                  ${isCopied 
                    ? 'bg-green-500 text-white scale-95' 
                    : 'bg-white text-gray-900 hover:bg-gray-100'}
                `}
              >
                {isCopied ? (
                  <>
                    <Check size={16} className="mr-2" />
                    복사 완료!
                  </>
                ) : (
                  <>
                    <Copy size={16} className="mr-2" />
                    해시태그 복사하기
                  </>
                )}
              </button>
            </div>
            
            <a 
              href="https://x.com/banggeulri819?s=21" 
              target="_blank" 
              rel="noreferrer"
              className="inline-flex items-center bg-blue-500 hover:bg-blue-600 text-white px-6 py-2.5 rounded-full text-sm font-bold transition-all shadow-lg transform hover:scale-105"
            >
              <Twitter size={16} className="mr-2" />
              트위터 바로가기
            </a>
          </div>
        </section>

        {/* 푸터 */}
        <footer className="text-center p-8 pb-12 text-gray-300 text-xs bg-white border-t border-gray-100 mt-6">
          <p className="mb-2">모든 문의는 트위터 DM으로 부탁드립니다.</p>
          <a href="https://x.com/banggeulri819?s=21" className="flex justify-center items-center text-gray-400 hover:text-orange-500 transition-colors mb-4">
            <MessageCircle size={12} className="mr-1" />
            @banggeulri819
          </a>
          <p className="font-mono opacity-50 text-[10px]">Managed by Jieun</p>
        </footer>

      </main>
    </div>
  );
};

export default BanggeulriGuide;
